<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ver documentos - Gestor Docs G3</title>
  <link rel="stylesheet" href="/assets/styles.css">
  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <script src="/components/navbar.js"></script>
  <div class="form-container" style="max-width: 800px;">
    <h1 class="form-title">üìÑ Documentos subidos</h1>
    <div id="docs-container"></div>
    <a href="/dashboard" class="back-link">‚Üê Volver al panel</a>
  </div>  <script>
    renderNavbar('ver-documentos');
    
    // Variable global para el rol del usuario
    let userRole = null;
    
    // Obtener rol del usuario al cargar la p√°gina
    async function getUserRole() {
      try {
        const response = await fetch('/api/auth/user', { credentials: 'include' });
        if (response.ok) {
          const userData = await response.json();
          userRole = userData.rol;
        }
      } catch (error) {
        console.error('Error obteniendo rol de usuario:', error);
      }
    }
      function renderComentarios(archivo, contenedor) {
      fetch('/api/comentarios?archivo=' + encodeURIComponent(archivo), { credentials: 'include' })
        .then(r => r.json())
        .then(data => {
          let html = `
            <div style="margin-top: 16px; padding: 16px; background: var(--neutral-50); border-radius: var(--radius-lg); border: 1px solid var(--neutral-200);">
              <h4 style="margin: 0 0 12px 0; color: var(--neutral-700); font-size: 14px;">üí¨ Comentarios</h4>
          `;
          
          if(!data.comentarios || data.comentarios.length === 0) {
            html += '<p style="margin: 0; color: var(--neutral-500); font-size: 14px;">No hay comentarios a√∫n</p>';
          } else {
            // Usar el HTML procesado del servidor (vulnerable a JS injection)
            html += '<div style="margin-bottom: 12px;">';
            html += data.html; // Aqu√≠ se inyecta el HTML del servidor
            html += '</div>';
          }
          
          // Solo mostrar formulario si es administrador
          if (userRole === 'admin') {
            html += `
              <form onsubmit="return enviarComentario(event, '${archivo}')" style="display: flex; gap: 8px;">
                <input type="text" name="comentario" placeholder="Agregar comentario..." required 
                       style="flex: 1; padding: 8px; border: 1px solid var(--neutral-300); border-radius: 6px; font-size: 13px;">
                <input type="hidden" name="archivo" value="${archivo}">
                <button type="submit" style="padding: 8px 16px; font-size: 13px; border-radius: 6px;">Comentar</button>
              </form>
            `;
          } else {
            html += `
              <div style="padding: 12px; background: var(--orange-50); border: 1px solid var(--orange-200); border-radius: 6px; margin-top: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="color: var(--orange-600); font-size: 16px;">üîí</span>
                  <span style="color: var(--orange-700); font-size: 13px; font-weight: 500;">Solo los administradores pueden agregar comentarios</span>
                </div>
              </div>
            `;
          }
          
          html += '</div>';
          contenedor.innerHTML = html;
        });
    }
    
    // Cargar y mostrar los documentos
    async function cargarDocumentos() {
      try {
        const response = await fetch('/api/documentos', { credentials: 'include' });
        if (!response.ok) throw new Error('Error al cargar documentos');
        
        const archivos = await response.json();
        const container = document.getElementById('docs-container');
        
        if (archivos.length === 0) {
          container.innerHTML = '<div class="info-card"><p>No hay documentos subidos a√∫n.</p></div>';
          return;
        }
        
        container.innerHTML = archivos.map(archivo => `
          <div class="form-group">
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: white; border: 1px solid var(--neutral-200); border-radius: var(--radius-lg); margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="color: var(--primary-600); font-size: 24px;">üìÑ</div>
                <div>
                  <h3 style="margin: 0; color: var(--neutral-800); font-size: 16px; font-weight: 600;">${archivo}</h3>
                  <p style="margin: 0; color: var(--neutral-500); font-size: 14px;">Documento PDF</p>
                </div>
              </div>              <div style="display: flex; gap: 8px;">
                <a href="/files/${encodeURIComponent(archivo)}" class="btn-secondary" style="font-size: 14px; padding: 8px 16px;" download>‚¨áÔ∏è Descargar</a>
                <button onclick="toggleComentarios('${archivo}')" class="btn-secondary" style="font-size: 14px; padding: 8px 16px;">üí¨ Comentarios</button>
              </div>
            </div>
            <div id="comentarios-${archivo.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none;"></div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('docs-container').innerHTML = '<div class="info-card"><p>Error al cargar documentos.</p></div>';      }
    }
    
    function toggleComentarios(archivo) {
      const id = 'comentarios-' + archivo.replace(/[^a-zA-Z0-9]/g, '');
      const container = document.getElementById(id);
      
      if (container.style.display === 'none') {
        container.style.display = 'block';
        // Solo renderizar si el container est√° vac√≠o
        if (container.innerHTML.trim() === '') {
          renderComentarios(archivo, container);
        }
      } else {
        container.style.display = 'none';
      }
    }
      async function enviarComentario(event, archivo) {
      event.preventDefault();
      const form = event.target;
      const comentario = form.comentario.value;
      
      try {
        const response = await fetch('/api/comentarios', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ archivo, comentario }),
          credentials: 'include'
        });
        
        if (response.ok) {
          form.comentario.value = '';
          // Recargar comentarios
          const id = 'comentarios-' + archivo.replace(/[^a-zA-Z0-9]/g, '');
          const container = document.getElementById(id);
          renderComentarios(archivo, container);
        } else if (response.status === 403) {
          // Error de permisos
          alert('‚ùå Solo los administradores pueden agregar comentarios');
        } else {
          alert('‚ùå Error al enviar comentario');
        }
      } catch (error) {
        console.error('Error al enviar comentario:', error);
        alert('‚ùå Error de conexi√≥n al enviar comentario');
      }
      
      return false;
    }
    
    // Inicializar p√°gina
    async function initPage() {
      await getUserRole();
      cargarDocumentos();
    }
    
    // Cargar p√°gina
    initPage();
  </script>
</body>
</html>
